---
title: "02-FinancialTimeSeries"
author: "Vivek 2012797"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

One type of financial data is financial time series. [Add more. Talk about what types of financial TS there are, what features they have, why they call for different methods of analysis.]


# Requirements

```{r requirements}
# List of required packages
required_packages <- c("ggplot2", "gridExtra")

# Function to check if packages are installed
new_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]

# Install missing packages
if(length(new_packages)) install.packages(new_packages)

# Load required packages
lapply(required_packages, library, character.only = TRUE)

# Load required packages
library(ggplot2)
library(gridExtra)
```

# Loading data

We obtain the stock data for Apple from Yahoo Finance API from [date] to now. (Improve sentence and give details. Explain what xts object is etc.)

Check https://bookdown.org/compfinezbook/introcompfinr/ReturnCalculationsR.html

```{r}
# Get historical stock data for Apple (AAPL) in xts format
getSymbols("AAPL", src = "yahoo", from = "2020-01-01", to = Sys.Date())
str(AAPL)
head(AAPL)
```

We see that the data comes in the form of an `xts` object. [Explain?] The variables present are shown in the table below.

| Variable Name | Description                                         |
|---------------|-----------------------------------------------------|
| Date          | The date of the stock price observation.           |
| Open          | The stock price at market open.                    |
| High          | The highest stock price during the trading day.    |
| Low           | The lowest stock price during the trading day.     |
| Close         | The stock price at market close.                   |
| Volume        | The total number of shares traded during the day.  |
| Adjusted      | The adjusted closing price, accounting for splits and dividends. |
| Daily_Return  | The percentage change in closing price from the previous day. |
| MA30          | The 30-day moving average of the closing price.    |


# Exploratory data analysis

We begin by performing exploratory data analysis. We use line plots to visualise the closing price and trading volume over time. We also use a 30-day moving average for the closing price to find the trend.

```{r}
# 1. Plot: Closing Price Over Time
p1 <- ggplot() +
  geom_line(aes(x = index(AAPL), y = coredata(AAPL$AAPL.Close)), color = "blue") +
  labs(title = "AAPL Closing Price Over Time", x = "Date", y = "Closing Price") +
  theme_minimal()

# 2. Plot: Volume Over Time
p2 <- ggplot() +
  geom_col(aes(x = index(AAPL), y = coredata(AAPL$AAPL.Volume)), fill = "lightblue") +
  labs(title = "AAPL Trading Volume Over Time", x = "Date", y = "Volume") +
  theme_minimal()

# Plot: Closing Price with 30-Day Moving Average
AAPL$MA30 <- rollmean(AAPL$AAPL.Close, k = 30, fill = NA, align = "right")

p3 <- ggplot() +
  geom_line(aes(x = index(AAPL), y = coredata(AAPL$AAPL.Close)), color = "blue") +
  geom_line(aes(x = index(AAPL), y = coredata(AAPL$MA30)), color = "red") +
  labs(title = "AAPL Closing Price with 30-Day Moving Average", x = "Date", y = "Price") +
  theme_minimal()

# Arrange plots in a grid
gridExtra::grid.arrange(p1, p2, p3, ncol = 1)
```

We can see that the closing price has [.... insert observations.].

A quantity of interest is the returns. Given the price process $\{P_t\}$, we can compute the log-return $X_t$ at time $t$ using the formula $$X_t = \log \left( \frac{P_t}{P_{t-1}} \right).$$ Note that if we have $N$ values for the price, we will have $N-1$ values for the log-returns. [Source needed:] We observe that $\{X_t\}$ has a sample path resembling that of a sequence of uncorrelated random variables with possibly time-varying variance.

1. Serial Dependence Without Correlation:
Explanation: Asset returns often exhibit no significant autocorrelation, which implies they are weakly dependent in terms of linear relationships (e.g., no strong correlation), but there may still be dependencies (e.g., in volatility or higher moments).
Plot: We'll plot autocorrelation (ACF) of returns to show the lack of linear dependence.
2. Volatility Clustering:
Explanation: High-volatility periods tend to be followed by high-volatility periods, and low-volatility periods tend to follow low-volatility periods. This is often visible in returns' time series.
Plot: Plot returns and highlight periods of high and low volatility.
3. Heavy-Tailed Distribution:
Explanation: Financial returns do not follow a normal distribution; they tend to have heavier tails, meaning extreme events (both positive and negative) occur more frequently than would be expected in a normal distribution.
Plot: A histogram of returns compared to a normal distribution.
4. Leverage Effect:
Explanation: Negative returns (e.g., price drops) are often followed by higher volatility. The effect can be analyzed by plotting returns against volatility.
Plot: Scatter plot of returns vs volatility (rolling standard deviation).

```{r}
# Calculate Daily Log Returns directly on the xts object
AAPL$Log_Returns <- diff(log(AAPL$AAPL.Close))

# Plot: Daily Log Returns
p4 <- ggplot() +
  geom_line(aes(x = index(AAPL), y = coredata(AAPL$Log_Returns)), color = "green") +
  labs(title = "AAPL Daily Log Returns", x = "Date", y = "Log Return") +
  theme_minimal()

# Log Returns (X_t)
AAPL$Log_Returns <- diff(log(AAPL$AAPL.Close))

# --- 1. Serial Correlation ---

# Set up the plotting area to display 3 plots side by side
par(mfrow = c(1, 3))  # Set up the plot window to have 1 row and 3 columns

# 1. ACF of X_t (log returns)
acf(AAPL$Log_Returns, na.action = na.omit, main = "ACF of X_t (Log Returns)")

# 2. ACF of |X_t| (absolute log returns)
acf(abs(AAPL$Log_Returns), na.action = na.omit, main = "ACF of |X_t| (Absolute Log Returns)")

# 3. ACF of X_t^2 (squared log returns)
acf(AAPL$Log_Returns^2, na.action = na.omit, main = "ACF of X_t^2 (Squared Log Returns)")

par(mfrow=c(1,1))

# --- 2. Volatility Clustering ---

# Plot X_t^2 (squared returns)
volatility_plot <- ggplot() +
  geom_line(aes(x = index(AAPL), y = coredata(AAPL$Log_Returns^2)), color = "blue") +
  labs(title = "Volatility Clustering: Squared Log Returns", x = "Date", y = "Squared Returns") +
  theme_minimal()

# Print volatility plot
print(volatility_plot)

# --- 3. Heavy-Tailedness ---

# Assuming AAPL data is already loaded and log returns are calculated
AAPL$Log_Returns <- diff(log(AAPL$AAPL.Close))

# Q-Q plot of log returns against a normal distribution
qqnorm(AAPL$Log_Returns, main = "Q-Q Plot: Log Returns vs. Normal Distribution", na.rm = TRUE)
qqline(AAPL$Log_Returns, col = "red", lwd = 2)  # Add a Q-Q line to compare to a normal distribution


# --- 4. Leverage Effect ---

# Assuming AAPL data is already loaded and log returns are calculated
AAPL$Log_Returns <- diff(log(AAPL$AAPL.Close))

# Calculate the absolute log returns
AAPL$Abs_Returns <- abs(AAPL$Log_Returns)

# Lag the returns by 1 period (no need to specify k = 1)
lagged_returns <- lag(AAPL$Log_Returns)

# Subset absolute returns based on lagged returns: |X_t| when X_{t-1} < 0 and |X_t| when X_{t-1} > 0
negative_lag <- AAPL$Abs_Returns[lagged_returns < 0 & !is.na(lagged_returns)]
positive_lag <- AAPL$Abs_Returns[lagged_returns > 0 & !is.na(lagged_returns)]

# Q-Q plot of |X_t| when X_{t-1} < 0 vs |X_t| when X_{t-1} > 0
qqplot(positive_lag, negative_lag,
       main = "Leverage Effect: Q-Q Plot of |X_t|",
       xlab = "|X_t| when X_{t-1} > 0",
       ylab = "|X_t| when X_{t-1} < 0",
       col = "blue", pch = 19)

# Add a 45-degree reference line
abline(0, 1, col = "red", lwd = 2)

```